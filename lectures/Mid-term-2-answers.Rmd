---
title: "Mid-term Exam 2"
author: "Jameson Watts, Ph.D."
date: "11/23/2019"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    toc_smooth: true
    number_sections: true
    df_print: kable
---


**Directions**

1. You have till noon to complete the exam
2. Everything (all code) needed to answer each problem should be included in this file so that I can reproduce your answers.
3. Sometimes you will be required to provide a written answer in addition to your code
4. Code blocks are already provided below each problem
5. When you are finished, submit both the Rmd file and knitted html file to the appropriate assignment on WISE

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
source('theme.R')
```

# Setup

## (3pts)

1. Revise this RMarkdown file so that you are the author.
2. Add YAML so that the knitted html produces a table of contents
3. With depth 2
4. That floats
5. And scrolls smoothly
6. with Kable tables

## (2pts)

2. Load the wine dataset,
3. get rid of wines with prices that are NA,
4. extract the year from the title,
5. make sure the new year variable is numeric
6. and remove years before 2000 and after 2015

```{r}
wine <- read_csv("../resources/winemag-data.csv") %>% 
  filter(!is.na(price)) %>%
  mutate(year = as.numeric(str_extract(title,"(\\d{4})"))) %>% 
  filter(year > 1999 & year < 2016)
```

# Descriptives

## (3pts)

What is the year with the highest prices on average in Texas? 

```{r}
wine %>% 
  filter(province=="Texas") %>% 
  group_by(year) %>% 
  summarize(price=mean(price)) %>% 
  top_n(1,price)
```

## (2pts)

Create a graph that compares standard deviation in wine price over time for Spain and Italy. 

```{r}
wine %>% 
  filter(country %in% c("Italy", "Spain")) %>% 
  group_by(country, year) %>% 
  summarize(sd = sd(price)) %>% 
  ggplot(aes(year,sd, color=country))+
  geom_line()
```




## (3pts)

Which country's wines (Italy or Spain) vary the most by year?

```{r}
wine %>% 
  filter(country %in% c("Italy", "Spain")) %>% 
  group_by(country, year) %>% 
  summarize(sd = sd(price)) %>%
  summarize(abg_sd = mean(sd))
```

# Advanced Visualization

## (5pts)

Create a dot plot that shows the change in average wine points for every region in Oregon between 2010 and 2015. Use the labs() function to make sure your plot has a title and informative x and y axis labels.

```{r}
wine %>% 
  filter(year %in% c(2010, 2015)) %>% 
  filter(province=="Oregon") %>% 
  group_by(region_1,year) %>% 
  summarise(points=mean(points)) %>% 
  ggplot(aes(x = points, y = region_1))+
  geom_path(arrow = arrow(length = unit(1.5, "mm"), type = "closed"))+
  labs(
    title = "Change in average points from 2010 to 2015 for Oregon wine",
    x = "Points",
    y = "Region")
```


## (5pts)

Find the three most prolific tasters. Then find the standard deviation in points and the standard deviation in log(price) within each variety for each of the three tasters identified. Finally, create a 2d density plot of your results faceted by the top 3 tasters.

```{r}
wine %>%
  drop_na(taster_name) %>%
  filter(
    taster_name %in% (
      wine %>% 
        drop_na(taster_name) %>% 
        count(taster_name) %>% 
        top_n(3))$taster_name
    ) %>% 
  group_by(taster_name, variety) %>% 
  summarize(sd_price=sd(log(price)), sd_points=sd(points)) %>% 
  ggplot(aes(sd_points,sd_price))+
  geom_density_2d()+
  facet_grid(.~taster_name)

```

## Bonus (1pt)

Provide a convincing interpretation of the plot from the previous question.

*Answer:*

# Regression

## (4pts)

Do points affect log(price) more for Chardonnay or Pinot Gris? In addition to running the regressions, please also write your answer in a way a manager can understand.

```{r}
library(moderndive)

r1 <- get_regression_table(lm(log(price)~points,data=wine %>% filter(variety == "Chardonnay")))
r2 <- get_regression_table(lm(log(price)~points,data=wine %>% filter(variety == "Pinot Gris")))

```

*Answer:* Each additional point increases price by `r round((exp(r1$estimate[2])-1)*100)`% for Chardonnay, but only `r round((exp(r2$estimate[2])-1)*100)`% for Pinot Gris.

## (5pts)

How does Roger Voss affect (i.e. interact with) the points ratings for Chardonnay, Pinot Gris and Sauvignon Blanc? Use regression to find coefficient estimates, and then explain these estimates in the space provided below.

*Hint:* You will need to filter the database for the selected varieties and create a new variable that indicates Roger Voss as the taster.

```{r}
d <- wine %>% 
  filter(variety %in% c("Chardonnay", "Pinot Gris", "Sauvignon Blanc")) %>% 
  mutate(roger=taster_name=="Roger Voss")

get_regression_table(lm(points~variety*roger,data=d))
              
```

*Answer:* Roger is a fan of Chardonnay and Sauvignon Blanc rating them 1 point and 1.4 points higher respectively than other tasters on average. He hates Pinot Gris.

## Bonus (1pt)

Graph the interaction of Roger Voss with Pinot Gris. How does this help with interpretation?

```{r}
d %>% 
  mutate(pinot_gris=variety=="Pinot Gris") %>% 
  drop_na(roger) %>% 
  group_by(roger, pinot_gris) %>% 
  summarise(points = mean(points)) %>% 
  ggplot() +
  aes(x = pinot_gris, y = points, color = roger) +
  geom_line(aes(group = roger)) +
  geom_point()
```

*Answer:*

## (2pts)

Does including year in a regression of log(price) on points improve the model? Justify your answer using the value of $R^2$ for each model.

```{r}
d <- wine %>% mutate(lprice = log(price))
get_regression_summaries(lm(lprice~points, data = d))
get_regression_summaries(lm(lprice~points+year, data = d))
```
*Answer:* Yes, the $R^2$ for the model that includes year is higher. 

## (4pts)
Answer the same question, but this time create training and test samples using an 80/20 split. Then use RMSE on the test data to justify your answer. If your answer is different from above, please explain.

```{r}
wine_shuffled <- wine %>% sample_frac(size = 1, replace = FALSE)
split <-  round(.8*nrow(wine_shuffled)) # 80% of dataframe
train <- wine_shuffled %>%
  slice(1:split)
test <- wine_shuffled %>%
  slice(split+1:nrow(wine_shuffled))

m1 <- lm(log(price)~points, data = train)
m2 <- lm(log(price)~points+year, data = train)

get_regression_points(m1, newdata = test) %>% 
  mutate(sq_residuals = residual^2) %>%
  summarize(rmse = sqrt(mean(sq_residuals)))

get_regression_points(m2, newdata = test) %>% 
  mutate(sq_residuals = residual^2) %>%
  summarize(rmse = sqrt(mean(sq_residuals)))
```

*Answer:*

## Bonus (1pt)

Create a 2d histogram residual plot from a regression of log(price) on points and year. Does it look ok?

```{r}
get_regression_points(lm(lprice~points+year, data = d)) %>% 
  ggplot(aes(points, residual))+
  geom_bin2d(bins=20)
```

*Answer:* Sorta... I'm a little worried that the residuals are skewed positive a bit
