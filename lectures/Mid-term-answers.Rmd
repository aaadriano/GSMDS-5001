---
title: "Mid-term Exam"
author: "Jameson Watts, Ph.D."
date: "10/12/2019"
output: html_document
---

### Directions

1. You have 120 minutes to complete the exam
2. Everything (all code) needed to answer each problem should be included in this file so that I can reproduce your answers
3. Sometimes you will be required to provide a written answer in addition to your code
4. Code blocks are already provided below each problem
5. When you are finished, submit both the Rmd file and knitted html file to the appropriate assignment on WISE

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
```

### Problem 1 (5pts)

1. Revise this RMarkdown file so that you are the author.
2. Load the wine dataset,
3. get rid of wines with prices that are NA,
4. extract the year from the title,
5. and make sure the new year variable is numeric

*Hint:* you can use the as.numeric() function to change a variable's type to numeric

```{r}
wine <- read_csv("../resources/winemag-data.csv") %>% 
  filter(!is.na(price)) %>%
  mutate(year = as.numeric(str_extract(title,"(\\d{4})")))
```

### Problem 2 (2pts)

What are the mean and median price of wines in the database? Use markdown to italicize each value in your written answer.

```{r}
wine %>% 
  summarize(mean=mean(price), median=median(price))
```

**Answer:** The mean is *36.5* and the median is *25*

### Problem 3 (3pts)

What are the mean and median price of Oregon Chardonnays? Use markdown to present your answer as an ordered list.

*Hint*: An ordered list won't be rendered correctly unless there is a blank line above it.

```{r}
wine %>% 
  filter(province=="Oregon") %>% 
  filter(variety=="Chardonnay") %>% 
  summarize(mean=mean(price), median=median(price))
```

**Answer:** 

1. The mean is: 34.9
2. The median is: 30

### Problem 4 (2pts)

How many unique countries are represented in our wine database? Make sure you use bold font for the number in your written answer.

```{r}
wine %>% 
  summarise(count = n_distinct(country))
```

**Answer:** There are **43** countries in the database.

### Problem 5 (4pts)

1. Create a tibble that shows the five countries with the most wines. 
2. Arrange the output by count descending.

```{r}
wine %>% 
  group_by(country) %>% 
  summarise(count=n_distinct(title)) %>%
  top_n(5,count) %>% 
  arrange(desc(count))
```

### Bonus (2pts)

Using the results from the prior Problem, embed R code directly into the following sentence to fill in the blank.

The US has `r round(50012/15817,2)` times as much wine as France.

### Problem 6 (4pts)

1. Create a tibble that shows the five US states with the highest average points 
2. for the Merlot variety of wine,
3. arranged by average points descending.

```{r}
wine %>% 
  filter(country == "US") %>%
  filter(variety == "Merlot") %>% 
  group_by(province) %>%
  summarize(avg_points=mean(points)) %>% 
  top_n(5,avg_points) %>% 
  arrange(desc(avg_points))
```

### Problem 7 (5pts)

1. Create a bar graph of the five US States with the highest priced Cabernet Sauvignon
2. Place the states names on the x axis and the highest price on the y axis

*Hint:* To improve the look of your graph, consider reordering columns directly within the aesthetic using something like x=reorder(province,-price)

```{r}
wine %>% 
  filter(country == "US") %>%
  filter(variety == "Cabernet Sauvignon") %>% 
  group_by(province) %>%
  summarise(price=max(price)) %>% 
  top_n(5, price) %>% 
  ggplot(aes(reorder(province,-price),price))+
    geom_col()
```

### Problem 8 (5pts)

1. Find the average price of Oregon, Washington, and California Pinot Gris by year
2. Graph this average over time where each state has its own line in the graph

*Hint:* set the color aesthetic to province and use a line geometry

```{r}
wine %>% 
  filter(variety=="Pinot Gris") %>% 
  filter(province %in% c("California","Washington","Oregon")) %>% 
  group_by(year, province) %>% 
  summarize(price=mean(price)) %>% 
  ggplot(aes(year,price,color=province))+
    geom_line()
```

### Problem 9 (5pts)

Explain each task accomplished by the below code. Please format your answer using an ordered list.

```{r}
wine %>% 
  filter(country %in% c("France","Spain","Portugal")) %>%
  mutate(taste=
    case_when(
      str_detect(description,"[Mm]ineral") ~ "earthy",
      str_detect(description,"[Sp]icy") ~ "spicy"
    )
  ) %>% 
  drop_na(taste) %>% 
  top_frac(0.001, points) %>% 
  select(title, price, points, taste)

```

**Answer:**


### Problem 10 (5pts)

Create bar plot that shows average rainfall from 1995 onwards.

*Hint:* you may want to mutate using if_else to change NA to 0 before summarize

```{r}
read_csv("../resources/rainfall.csv") %>% 
  pivot_longer(-Year,names_to = "month", values_to = "rainfall") %>% 
  mutate(rainfall=if_else(is.na(rainfall),0,rainfall)) %>% 
  group_by(Year) %>% 
  summarise(rainfall=mean(rainfall)) %>% 
  filter(Year >= 1995) %>% 
  ggplot(aes(Year,rainfall))+
    geom_col()
```

### Problem 11 (5pts)

Create a scatter (i.e., point) plot that shows the relationship between the log of september rainfall and average price for wines in the Dundee Hills region. Does it look like there is a relationship?

```{r}
read_csv("../resources/rainfall.csv") %>% 
  pivot_longer(-Year,names_to = "month", values_to = "rainfall") %>% 
  rename("year"="Year") %>% 
  filter(month=="Sep") %>% 
  right_join(wine) %>% 
  filter(region_1=="Dundee Hills") %>% 
  group_by(rainfall) %>% 
  summarise(price=mean(price)) %>% 
  ggplot(aes(log(rainfall),price))+
    geom_point()
  
```

**Answer:**

### Bonus (3pts)

What are the top scoring wines from the ten french wineries with the highest average prices? Only include wineries that produce 5 or more wines.

*Note:* For full credit, use 10 operations (piped lines of code) or less.

```{r}
wine %>% 
  filter(country=="France") %>%
  group_by(winery) %>% 
  summarize(
    count=n(), 
    avg_price=mean(price)) %>% 
  filter(count>=5) %>% 
  top_n(10,avg_price) %>% 
  left_join(wine) %>%
  arrange(winery,desc(points)) %>% 
  group_by(winery) %>% 
  summarize(title=first(title), points=first(points))
```

